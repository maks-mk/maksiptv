# MaksIPTV Плеер

Приложение для просмотра IPTV каналов с поддержкой M3U/M3U8 плейлистов.

## Возможности

- Чтение и парсинг M3U/M3U8 плейлистов с локального диска и из интернета
- Поддержка разбиения каналов по категориям
- Избранные каналы
- Скрытие каналов
- Полноэкранный режим (выход по ESC или кнопке)
- Управление аудиодорожками
- Создание скриншотов
- Настройки буферизации для стабильного воспроизведения
- История плейлистов
- Современный UI с темной темой, адаптивными элементами и плавными анимациями
- Расширенная обработка ошибок и логирование

## Технические детали

- Использует библиотеку python-vlc для воспроизведения медиа
- Встроенный парсер для IPTV плейлистов формата M3U/M3U8
- Интерфейс на PyQt5
- Поддержка ОС Windows, Linux, MacOS
- Система логирования для отладки

## Горячие клавиши

- **ESC** - выход из полноэкранного режима
- **F** - полноэкранный режим
- **Space** - воспроизведение/пауза
- **A** - переключение аудиодорожки

## Зависимости

```
python-vlc
PyQt5
```

## Установка

```bash
pip install PyQt5 python-vlc
```

## Запуск

```bash
python main.py
```

## Последние улучшения

- Добавлена система автоматического переподключения к каналам при ошибках воспроизведения
- Добавлен счетчик попыток переподключения с отображением в статусбаре
- Оптимизирована обработка ошибок и событий VLC
- Улучшены стандартные иконки для кнопок Избранное, Скрытые каналы и Обновление из интернета
- Устранены проблемы с дублированием инициализации VLC
- Добавлено корректное освобождение ресурсов при закрытии приложения
- Улучшена обработка ошибок воспроизведения
- Добавлена оптимизированная работа с временными файлами
- Реализована система логирования с сохранением в файл
- Улучшена стабильность воспроизведения за счет дополнительных параметров
- Добавлено корректное распознавание аудио-каналов без видеопотока
- Оптимизирована обработка состояний медиаплеера
- Улучшен встроенный парсер плейлистов с поддержкой расширенных тегов
- Добавлено переключение аудиодорожек
- Оптимизировано кэширование для устранения задержек и буферизации
- Добавлена возможность удаления отдельных плейлистов из истории
- Полностью переработан пользовательский интерфейс
  - Современный дизайн с закругленными элементами
  - Улучшенная цветовая схема для снижения нагрузки на глаза
  - Адаптивная разметка и масштабирование
  - Улучшенные иконки и визуальные подсказки
  - Оптимизированная компоновка элементов управления

## Требования

* Python 3.6+
* VLC медиаплеер (https://www.videolan.org/vlc/)
* PyQt5
* python-vlc

## Установка

1. Убедитесь, что у вас установлен VLC медиаплеер.
2. Установите необходимые зависимости:

```
pip install -r requirements.txt
```

## Использование

1. Поместите ваш M3U плейлист в директорию проекта с именем `IPTV_SHARED.m3u`
2. Запустите приложение:

```
python main.py
```

3. Для работы с плейлистами используйте следующие функции:
   * **Открыть плейлист** - выбор локального плейлиста с компьютера
   * **Недавние плейлисты** - быстрый доступ к последним использованным плейлистам
   * **Добавить плейлист из URL** - скачивание плейлиста по ссылке
   * **Обновить из интернета** - автоматическое обновление плейлиста с сервера

## Функции

* Современный темный интерфейс
* Разбиение каналов по категориям из group-title
* Удобная навигация по категориям с древовидным представлением
* Воспроизведение IPTV каналов с поддержкой опций из плейлиста
* **Автоматическое переподключение при ошибках воспроизведения**
* **Отображение счетчика попыток переподключения**
* **Отображение логотипов каналов (tvg-logo)**
* Работа с несколькими плейлистами (локальными и из интернета)
* История недавно использованных плейлистов
* Автоматическое обновление плейлиста из интернета
* Управление громкостью
* Полноэкранный режим (клавиша F или ESC для выхода)
* Поиск каналов по названию
* Сортировка каналов по алфавиту
* Избранные каналы с возможностью быстрого доступа
* Скрытие нежелательных каналов
* Скриншоты при просмотре
* Скрытие в системный трей
* Поддержка горячих клавиш
* Улучшенное отображение ошибок воспроизведения
* Статус-бар с информацией о текущем канале
* Главное меню с доступом ко всем функциям
* Автоматический выбор первого канала после загрузки плейлиста
* Проверка повторной загрузки одного и того же плейлиста
* **Корректное отображение количества каналов: показывается общее и видимое количество (без скрытых)**
* Воспроизведение IPTV каналов из M3U/M3U8 плейлистов
* Поддержка категорий каналов
* Список избранных каналов
* Поиск каналов
* Поддержка иконок каналов из плейлистов
  * Автоматическая загрузка иконок из URL, указанных в плейлисте
  * Кеширование загруженных иконок для ускорения работы
  * Отображение иконок в списке каналов и в древовидном представлении
* Скрытие ненужных каналов
* Сортировка каналов по алфавиту
* Управление с клавиатуры
* Поддержка трея (сворачивание в системный трей)
* Возможность делать скриншоты
* Полноэкранный режим

## UI/UX особенности

* **Современный дизайн**
  * Темная тема с пониженной нагрузкой на глаза
  * Закругленные элементы интерфейса
  * Мягкие цветовые переходы и тени
  * Оптимизированное использование пространства
  
* **Удобство использования**
  * Интуитивно понятное расположение элементов управления
  * Визуальная обратная связь при взаимодействии
  * Чередующиеся цвета строк для улучшения читаемости списков
  * Всплывающие подсказки с информацией о функциях
  * Компактные панели управления воспроизведением
  
* **Адаптивность**
  * Интерфейс подстраивается под размер окна
  * Возможность изменения соотношения панелей через сплиттер
  * Автоматический выбор оптимального размера элементов
  * Поддержка масштабирования интерфейса

## Управление

* **Главное меню** - доступ ко всем функциям:
  * Файл: работа с плейлистами, снимки экрана, выход
  * Каналы: управление избранными и скрытыми каналами
  * Справка: информация о программе

* **Управление плейлистами**:
  * Открыть плейлист - выбор локального плейлиста через диалог
  * Недавние плейлисты - быстрый доступ к последним 5 плейлистам
  * Добавить плейлист из URL - скачивание плейлиста по ссылке
  * Перезагрузить плейлист - обновление текущего плейлиста
  * Обновить из интернета - загрузка обновленного плейлиста с сервера

* **Управление каналами**:
  * Выбор категории - выпадающий список для выбора категории каналов
  * Поиск - фильтрация каналов по названию
  * Сортировка - кнопка для сортировки каналов по алфавиту
  * **Отображение логотипов каналов**
  * Контекстное меню канала - доступно по правому клику на канале:
    * Воспроизвести - начать воспроизведение
    * Добавить/Удалить из избранного - управление избранными
    * Скрыть/Показать канал - управление видимостью
    * Информация о канале - просмотр деталей
  * **В панели и статус-баре отображается: всего каналов и видимых (без скрытых)**

* **Управление воспроизведением**:
  * Воспроизведение/пауза (Пробел)
  * Стоп - остановка воспроизведения
  * Полный экран (F или ESC для выхода)
  * Снимок экрана - сохранение скриншота текущего кадра
  * Регулировка громкости
  * **Автоматическое восстановление при ошибках воспроизведения**:
    * При разрыве соединения или ошибке стрима система автоматически пытается переподключиться
    * Счетчик попыток переподключения отображается в статусбаре
    * Переподключение происходит каждые 3 секунды до восстановления связи
    * При смене канала счетчик попыток сбрасывается

## История плейлистов

Программа автоматически сохраняет информацию о последних использованных плейлистах:
* Сохраняются пути к локальным плейлистам и URL-адреса
* Доступ через меню "Файл" → "Недавние плейлисты"
* Хранит до 5 последних плейлистов
* При выборе несуществующего плейлиста предлагает удалить его из истории
* Поддерживает как локальные файлы, так и URL-адреса

## Избранные и скрытые каналы

* **Избранные каналы** - каналы, добавленные в избранное:
  * Доступны через категорию "Избранное"
  * Управление через меню "Каналы" → "Избранное"
  * Быстрое добавление/удаление через контекстное меню канала

* **Скрытые каналы** - каналы, которые не отображаются в списках:
  * Скрытие через контекстное меню канала
  * Управление через меню "Каналы" → "Скрытые каналы"
  * Возможность просмотра списка скрытых каналов
  * Восстановление всех скрытых каналов одной командой

## Логотипы каналов

* Функция отображения логотипов каналов удалена в текущей версии.
* В предыдущих версиях программа могла отображать логотипы через тег `tvg-logo` в плейлисте.

## Обновление плейлиста

Программа поддерживает работу с несколькими источниками плейлистов:

1. **Локальные плейлисты**:
   * Открытие через меню "Файл" → "Открыть плейлист"
   * Возможность копирования в директорию программы или использования без копирования
   * Проверка на повторную загрузку того же плейлиста

2. **Плейлисты из интернета**:
   * Загрузка произвольного плейлиста по URL
   * Автоматическое обновление стандартного плейлиста
   * Надежная система скачивания с таймаутами и обработкой ошибок
   * Очистка устаревших временных файлов

Стандартный плейлист программа обновляет со следующего URL:
```
https://gitlab.com/iptv135435/iptvshared/raw/main/IPTV_SHARED.m3u
```

При обновлении:
1. Создается резервная копия текущего плейлиста (с расширением .backup)
2. Скачивается новый плейлист
3. После успешного скачивания плейлист автоматически перезагружается
4. При ошибке обновления восстанавливается резервная копия

## Горячие клавиши

* **Пробел** - воспроизведение/пауза
* **F** - полноэкранный режим
* **ESC** - выход из полноэкранного режима

## Снимки экрана

Программа позволяет делать снимки экрана во время воспроизведения канала:
* Через кнопку в панели управления
* Через меню "Файл" → "Сделать снимок экрана"
* Снимки сохраняются в папку `screenshots` в директории с программой
* Имя файла включает название канала и временную метку

## Системный трей

Приложение минимизируется в системный трей при закрытии. Для полного выхода используйте опцию "Выход" в контекстном меню трея или в главном меню "Файл" → "Выход".

## Система логирования

Программа создает детальные логи работы в папке `logs`:
* Записываются все ошибки и предупреждения
* Файлы логов создаются с датой в имени (`iptv_player_YYYYMMDD.log`)
* Логи помогают находить и устранять проблемы

## Структура плейлиста

Плеер поддерживает стандартный формат M3U плейлистов. Для корректного разбиения по категориям, каналы должны содержать атрибут `group-title`. Для отображения логотипов каналов используется атрибут `tvg-logo`:

```
#EXTINF:-1 tvg-id="example" tvg-logo="http://example.com/logo.png" group-title="Фильмы",Название канала
http://example.com/stream
```

## Решение проблем

Если при воспроизведении возникают ошибки:

1. Убедитесь, что установлен VLC Media Player
2. Проверьте, что ссылки в плейлисте активны и доступны
3. Для каналов, требующих user-agent, он должен быть указан в формате `#EXTVLCOPT:http-user-agent=UserAgent`
4. При проблемах с обновлением плейлиста, проверьте подключение к интернету
5. При проблемах с отображением логотипов, проверьте наличие доступа к интернету и корректность ссылок в теге `tvg-logo`
6. **Если количество каналов кажется некорректным — проверьте, не скрыты ли некоторые каналы (отображается и общее, и видимое количество)**
7. При проблемах с воспроизведением проверьте логи в папке `logs`

### Не загружаются иконки каналов

Если иконки каналов не загружаются, проверьте:
1. Доступность интернет-соединения
2. Корректность URL иконок в плейлисте
3. Наличие прав на запись в папку кеша (по умолчанию `.cache/icons` в директории приложения)

Программа автоматически кеширует загруженные иконки для ускорения работы при следующем запуске. 